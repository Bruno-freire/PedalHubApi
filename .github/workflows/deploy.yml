on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to EC2 Windows
    runs-on: windows-latest

    steps:
      - name: Checkout the files
        uses: actions/checkout@v3

      - name: Deploy files via SSH
        env: 
          SSH_PRIVATE_KEY: ${{secrets.EC2_SSH_KEY}}
          REMOTE_HOST: ${{secrets.HOST}}
          REMOTE_USER: ${{secrets.USER}}
        run: |
          $keyFile = "$env:TEMP\key.pem"
          
          Set-Content -Path $keyFile -Value $env:SSH_PRIVATE_KEY
          
          $remotePath = "/c/Users/Administrator/Desktop/PedalHubApi"
          $scpOptions = "-o StrictHostKeyChecking=no -o UserKnownHostsFile=$env:TEMP\known_hosts"
          
          # Cria o diretório remoto caso não exista
          ssh -i $keyFile $scpOptions "$($REMOTE_USER)@$($REMOTE_HOST)" "mkdir -p $remotePath"
          
          # Copia os arquivos para o diretório remoto
          scp -i $keyFile $scpOptions -r ./* "$($REMOTE_USER)@$($REMOTE_HOST):$remotePath"
